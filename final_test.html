<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Sales Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 p-4">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Final Sales System Test</h1>
        
        <!-- Status Panel -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">System Status</h2>
            <div id="systemStatus" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                    <div id="authStatus" class="text-2xl mb-2">⏳</div>
                    <div class="text-sm">Authentication</div>
                </div>
                <div class="text-center">
                    <div id="apiStatus" class="text-2xl mb-2">⏳</div>
                    <div class="text-sm">API Connection</div>
                </div>
                <div class="text-center">
                    <div id="searchStatus" class="text-2xl mb-2">⏳</div>
                    <div class="text-sm">Search Function</div>
                </div>
            </div>
        </div>
        
        <!-- Search Test -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">Medicine Search Test</h2>
            
            <div class="mb-4">
                <div class="flex space-x-2">
                    <input type="text" id="medicineSearch" placeholder="Type 'para' to search..."
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button onclick="manualSearch()" class="bg-blue-600 text-white px-4 py-2 rounded">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div id="medicineResults" class="mt-2 max-h-60 overflow-y-auto border border-gray-200 rounded-md hidden"></div>
            </div>
        </div>
        
        <!-- Cart Test -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">Shopping Cart</h2>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Medicine</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Price</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Qty</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                        </tr>
                    </thead>
                    <tbody id="cartItems" class="bg-white divide-y divide-gray-200">
                        <tr id="emptyCart">
                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">No items in cart</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 flex space-x-2">
                <button onclick="addTestItem()" class="bg-green-600 text-white px-4 py-2 rounded">
                    Add Test Item
                </button>
                <button onclick="clearCart()" class="bg-red-600 text-white px-4 py-2 rounded">
                    Clear Cart
                </button>
            </div>
        </div>
        
        <!-- Totals -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
            
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span>Subtotal:</span>
                    <span id="subtotal">Rs 0.00</span>
                </div>
                <div class="flex justify-between">
                    <span>Discount:</span>
                    <input type="number" id="discountAmount" value="0" min="0" step="0.01"
                           class="w-20 px-2 py-1 border rounded text-sm" onchange="updateTotals()">
                </div>
                <div class="flex justify-between">
                    <span>Tax (18%):</span>
                    <span id="taxAmount">Rs 0.00</span>
                </div>
                <hr>
                <div class="flex justify-between text-lg font-bold">
                    <span>Total:</span>
                    <span id="totalAmount" class="text-green-600">Rs 0.00</span>
                </div>
            </div>
        </div>
        
        <!-- Debug Log -->
        <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-white">Debug Log</h3>
                <button onclick="clearLog()" class="bg-red-600 text-white px-2 py-1 rounded text-xs">Clear</button>
            </div>
            <div id="debugLog" class="h-40 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        let cart = [];
        
        // Debug logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-green-400',
                error: 'text-red-400',
                success: 'text-blue-400',
                warning: 'text-yellow-400'
            };
            logDiv.innerHTML += `<div class="${colors[type]}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }
        
        // Status updates
        function updateStatus(element, success, message = '') {
            const statusEl = document.getElementById(element);
            statusEl.textContent = success ? '✅' : '❌';
            statusEl.title = message;
        }
        
        // API path helper
        function getApiPath(filename) {
            return 'api/' + filename;
        }
        
        // Test functions
        async function runSystemTests() {
            log('Starting system tests...', 'info');
            
            // Test API connection
            try {
                const response = await fetch(getApiPath('search_medicines.php'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: 'test' })
                });
                
                updateStatus('apiStatus', response.ok, `HTTP ${response.status}`);
                log(`API Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    updateStatus('authStatus', data.success !== false, data.message || 'OK');
                    log(`Auth Status: ${data.success ? 'OK' : 'Failed - ' + data.message}`, data.success ? 'success' : 'error');
                }
                
            } catch (error) {
                updateStatus('apiStatus', false, error.message);
                updateStatus('authStatus', false, 'Cannot test - API failed');
                log(`API Error: ${error.message}`, 'error');
            }
            
            // Test search
            await testSearch();
        }
        
        async function testSearch() {
            try {
                const response = await fetch(getApiPath('search_medicines.php'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: 'para' })
                });
                
                const data = await response.json();
                const hasResults = data.success && data.medicines && data.medicines.length > 0;
                
                updateStatus('searchStatus', hasResults, hasResults ? `Found ${data.medicines.length} medicines` : 'No results');
                log(`Search Test: ${hasResults ? 'SUCCESS' : 'FAILED'} - ${hasResults ? data.medicines.length + ' results' : data.message || 'No results'}`, hasResults ? 'success' : 'warning');
                
            } catch (error) {
                updateStatus('searchStatus', false, error.message);
                log(`Search Test Error: ${error.message}`, 'error');
            }
        }
        
        function manualSearch() {
            const query = document.getElementById('medicineSearch').value.trim();
            const resultsDiv = document.getElementById('medicineResults');
            
            log(`Manual search: "${query}"`, 'info');
            
            if (query.length < 2) {
                resultsDiv.innerHTML = '<div class="p-3 text-yellow-600">Please enter at least 2 characters</div>';
                resultsDiv.classList.remove('hidden');
                return;
            }
            
            resultsDiv.innerHTML = '<div class="p-3 text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Searching...</div>';
            resultsDiv.classList.remove('hidden');
            
            fetch(getApiPath('search_medicines.php'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            })
            .then(response => {
                log(`Search response: ${response.status}`, 'info');
                return response.json();
            })
            .then(data => {
                log(`Search data: ${JSON.stringify(data)}`, 'info');
                
                if (data.success && data.medicines && data.medicines.length > 0) {
                    let html = '<div class="p-2">';
                    data.medicines.forEach(medicine => {
                        html += `
                            <div class="p-3 hover:bg-gray-50 cursor-pointer border-b" onclick="addToCart(${medicine.id}, '${medicine.name}', ${medicine.selling_price}, ${medicine.stock_quantity})">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-medium text-gray-800">${medicine.name}</p>
                                        <p class="text-sm text-gray-600">${medicine.generic_name || ''}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-medium text-green-600">Rs ${parseFloat(medicine.selling_price).toFixed(2)}</p>
                                        <p class="text-xs text-gray-500">Stock: ${medicine.stock_quantity}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    resultsDiv.innerHTML = html;
                    log(`Displayed ${data.medicines.length} results`, 'success');
                } else {
                    resultsDiv.innerHTML = '<div class="p-3 text-gray-500">No medicines found</div>';
                    log('No medicines found', 'warning');
                }
            })
            .catch(error => {
                log(`Search error: ${error.message}`, 'error');
                resultsDiv.innerHTML = '<div class="p-3 text-red-500">Error: ' + error.message + '</div>';
            });
        }
        
        function addToCart(medicineId, medicineName, price, stockQuantity) {
            log(`Adding to cart: ${medicineName}`, 'info');
            
            const existingItem = cart.find(item => item.medicineId === medicineId);
            
            if (existingItem) {
                existingItem.quantity++;
                existingItem.total = existingItem.quantity * existingItem.price;
            } else {
                cart.push({
                    medicineId: medicineId,
                    name: medicineName,
                    price: parseFloat(price),
                    quantity: 1,
                    total: parseFloat(price),
                    stockQuantity: stockQuantity
                });
            }
            
            updateCartDisplay();
            updateTotals();
            
            // Clear search
            document.getElementById('medicineSearch').value = '';
            document.getElementById('medicineResults').classList.add('hidden');
            
            log(`Cart updated. Items: ${cart.length}`, 'success');
        }
        
        function addTestItem() {
            addToCart(999, 'Test Medicine', 25.00, 100);
        }
        
        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const emptyCart = document.getElementById('emptyCart');
            
            if (cart.length === 0) {
                if (emptyCart) emptyCart.style.display = 'table-row';
                return;
            }
            
            if (emptyCart) emptyCart.style.display = 'none';
            
            const cartHTML = cart.map((item, index) => `
                <tr>
                    <td class="px-4 py-2">
                        <div class="text-sm font-medium text-gray-900">${item.name}</div>
                    </td>
                    <td class="px-4 py-2 text-sm text-gray-900">Rs ${item.price.toFixed(2)}</td>
                    <td class="px-4 py-2">
                        <div class="flex items-center space-x-2">
                            <button onclick="updateQuantity(${index}, -1)" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-minus-circle"></i>
                            </button>
                            <span class="text-sm font-medium w-8 text-center">${item.quantity}</span>
                            <button onclick="updateQuantity(${index}, 1)" class="text-green-600 hover:text-green-800">
                                <i class="fas fa-plus-circle"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">Rs ${item.total.toFixed(2)}</td>
                    <td class="px-4 py-2">
                        <button onclick="removeFromCart(${index})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            cartItems.innerHTML = cartHTML + '<tr id="emptyCart" style="display: none;"><td colspan="5" class="px-4 py-8 text-center text-gray-500">No items in cart</td></tr>';
        }
        
        function updateQuantity(index, change) {
            const item = cart[index];
            const newQuantity = item.quantity + change;
            
            if (newQuantity <= 0) {
                removeFromCart(index);
                return;
            }
            
            item.quantity = newQuantity;
            item.total = item.quantity * item.price;
            
            updateCartDisplay();
            updateTotals();
        }
        
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartDisplay();
            updateTotals();
            log('Item removed from cart', 'info');
        }
        
        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + item.total, 0);
            const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
            const taxableAmount = subtotal - discountAmount;
            const taxAmount = taxableAmount * 0.18;
            const totalAmount = taxableAmount + taxAmount;
            
            document.getElementById('subtotal').textContent = 'Rs ' + subtotal.toFixed(2);
            document.getElementById('taxAmount').textContent = 'Rs ' + taxAmount.toFixed(2);
            document.getElementById('totalAmount').textContent = 'Rs ' + totalAmount.toFixed(2);
        }
        
        function clearCart() {
            cart = [];
            updateCartDisplay();
            updateTotals();
            log('Cart cleared', 'info');
        }
        
        // Auto-search
        document.getElementById('medicineSearch').addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(manualSearch, 500);
        });
        
        // Initialize
        log('Final test page loaded', 'success');
        runSystemTests();
    </script>
</body>
</html>